#include "SaveController.h"

#include <utility>

#include "../ECS/Components/Health.h"
#include "../ECS/Components/Intelligence.h"
#include "../ECS/Components/Money.h"
#include "../ECS/Components/Transform.h"
#include "../ECS/Components/Weapon.h"
#include "../ECS/Markers/PlayerMarker.h"
#include "../ECSLib/Core/Filter.h"
#include "../ECSLib/Core/World.h"
#include "../Message/PlayerInfoMessage.h"
#include "../Utility/Log/Log.h"
#include "Field/FieldHelper.h"

void SaveController::save(const Field& field, World& world) const {
  auto filter = Filter::with<PlayerMarker, Health, Money, Transform, Weapon,
                             Intelligence>(world);
  if (filter.empty()) {
    LOG_ERROR_F("No player found while saving");
    return;
  }
  auto player = filter.at(0);

  int health = player.getComponent<Health>().value;
  int money = player.getComponent<Money>().value;
  Point position = player.getComponent<Transform>().position;
  int weapon = player.getComponent<Weapon>().damage;
  int intelligence = player.getComponent<Intelligence>().value;
  PlayerInfoMessage player_info{health, money, position, weapon, intelligence};

  GameState game_state{FieldHelper::info(field), player_info};
  try {
    _saver.save(game_state);
  } catch (const std::runtime_error& e) {
    LOG_ERROR_F("Saver error: " + std::string(e.what()));
    return;
  }
  LOG_INFO_F("Game saved");
}

std::shared_ptr<Field> SaveController::load(World& world,
                                            EventFactory& event_factory) {
  GameState game_state;
  try {
    game_state = _saver.load();
  } catch (const std::runtime_error& e) {
    LOG_ERROR_F("Saver error: " + std::string(e.what()));
    return nullptr;
  }
  auto& field_info = game_state.field_info;
  auto& player_info = game_state.player_info;

  auto filter = Filter::with<PlayerMarker, Health, Money, Transform, Weapon,
                             Intelligence>(world);
  if (filter.empty()) {
    LOG_ERROR_F("No player found while loading");
    return nullptr;
  }
  auto player = filter.at(0);

  player.getComponent<Health>().value = player_info.health;
  player.getComponent<Money>().value = player_info.money;
  player.getComponent<Transform>().position = player_info.position;
  player.getComponent<Weapon>().damage = player_info.weapon;
  player.getComponent<Intelligence>().value = player_info.intelligence;

  std::vector<std::vector<Cell>> cells;
  auto& size = field_info.size;
  cells.reserve(size.y);
  for (int j = 0; j < size.y; ++j) {
    cells[j].reserve(size.x);
    for (int i = 0; i < size.x; ++i) {
    }
  }

  LOG_INFO_F("Game loaded");
  LOG_INFO_F("Player stats: Health = " + std::to_string(player_info.health) +
             ", Money = " + std::to_string(player_info.money) +
             ", Weapon damage = " + std::to_string(player_info.weapon) +
             ", Intelligence = " + std::to_string(player_info.intelligence));
}
